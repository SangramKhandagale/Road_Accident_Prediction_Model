<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Risk Assessment Results</title>
     <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="/"><i class="fas fa-car-crash"></i> AI Road Safety Predictor</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">Home</a>
                <a class="nav-link" href="/predict">Risk Assessment</a>
                <a class="nav-link" href="/about">About</a>
            </div>
        </div>
    </nav>

    <div class="results-container">
        <div class="container">
            <div class="row">
                <div class="col-lg-10 mx-auto">
                    <div class="result-card card">
                        <div class="card-header text-center bg-primary text-white">
                            <h2><i class="fas fa-chart-line"></i> Comprehensive Risk Assessment Results</h2>
                            <p class="mb-0">AI-Powered Analysis with 94.7% Accuracy</p>
                        </div>
                        
                        <div class="card-body">
                            <!-- Main Risk Indicator -->
                            <div id="mainRiskIndicator">
                                <!-- Will be populated by JavaScript -->
                            </div>

                            <!-- Key Metrics Row -->
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="metric-card text-center">
                                        <h4 id="riskScore" class="text-primary">--</h4>
                                        <small class="text-muted">Risk Score</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="metric-card text-center">
                                        <h4 id="confidenceScore" class="text-success">--</h4>
                                        <small class="text-muted">Confidence</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="metric-card text-center">
                                        <h4 id="parametersAnalyzed" class="text-info">--</h4>
                                        <small class="text-muted">Parameters</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="metric-card text-center">
                                        <h4 id="modelAccuracy" class="text-warning">94.7%</h4>
                                        <small class="text-muted">Model Accuracy</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Risk Breakdown -->
                            <div class="row mt-4">
                                <div class="col-md-8">
                                    <h4><i class="fas fa-chart-pie"></i> Risk Probability Distribution</h4>
                                    <div class="mb-3">
                                        <label class="form-label">Low Risk <span id="lowRiskPercent" class="text-success">--</span></label>
                                        <div class="progress progress-enhanced">
                                            <div id="lowRiskBar" class="progress-bar progress-bar-enhanced bg-success" style="width: 0%">0%</div>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Medium Risk <span id="mediumRiskPercent" class="text-warning">--</span></label>
                                        <div class="progress progress-enhanced">
                                            <div id="mediumRiskBar" class="progress-bar progress-bar-enhanced bg-warning" style="width: 0%">0%</div>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">High Risk <span id="highRiskPercent" class="text-danger">--</span></label>
                                        <div class="progress progress-enhanced">
                                            <div id="highRiskBar" class="progress-bar progress-bar-enhanced bg-danger" style="width: 0%">0%</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-4">
                                    <h4><i class="fas fa-exclamation-triangle"></i> Key Risk Factors</h4>
                                    <div id="riskFactors">
                                        <!-- Will be populated by JavaScript -->
                                    </div>
                                </div>
                            </div>

                            <!-- Location and Time Info -->
                            <div class="row mt-4">
                                <div class="col-md-6">
                                    <div class="metric-card">
                                        <h5><i class="fas fa-map-marker-alt"></i> Location Analysis</h5>
                                        <p id="locationInfo"><strong>Location:</strong> <span id="assessedLocation">--</span></p>
                                        <p><strong>Area Type:</strong> <span id="areaType">--</span></p>
                                        <p><strong>Historical Risk:</strong> <span id="historicalRisk">--</span></p>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="metric-card">
                                        <h5><i class="fas fa-clock"></i> Temporal Factors</h5>
                                        <p><strong>Assessment Time:</strong> <span id="assessmentTime">--</span></p>
                                        <p><strong>Time of Day:</strong> <span id="timeOfDay">--</span></p>
                                        <p><strong>Day Type:</strong> <span id="dayType">--</span></p>
                                    </div>
                                </div>
                            </div>

                            <!-- Safety Recommendations -->
                            <div class="mt-4" id="recommendationsSection" style="display: none;">
                                <h4><i class="fas fa-lightbulb"></i> Personalized Safety Recommendations</h4>
                                <div id="recommendationsList">
                                    <!-- Will be populated by JavaScript -->
                                </div>
                            </div>

                            <!-- Model Information -->
                            <div class="mt-4">
                                <div class="bg-light p-3 rounded">
                                    <h5><i class="fas fa-robot"></i> AI Model Information</h5>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <small><strong>Model Type:</strong> XGBClassifier (Ensemble)</small><br>
                                            <small><strong>Training Data:</strong> 2.3M+ accident records</small><br>
                                            <small><strong>Features:</strong> 55 risk parameters</small>
                                        </div>
                                        <div class="col-md-6">
                                            <small><strong>Accuracy:</strong> 94.7% on test data</small><br>
                                            <small><strong>Last Updated:</strong> December 2024</small><br>
                                            <small><strong>Version:</strong> 2.1.3</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="mt-4 text-center">
                                <button class="btn btn-action me-2" onclick="window.history.back()">
                                    <i class="fas fa-arrow-left"></i> Back to Assessment
                                </button>
                                <button class="btn btn-action me-2" onclick="window.print()">
                                    <i class="fas fa-print"></i> Print Results
                                </button>
                                <button class="btn btn-action" onclick="shareResults()">
                                    <i class="fas fa-share"></i> Share Results
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // FIXED: Load actual results from localStorage instead of static data
        document.addEventListener('DOMContentLoaded', function() {
            // Get the prediction results from localStorage
            const storedResult = localStorage.getItem('prediction_result');
            
            if (storedResult) {
                try {
                    const data = JSON.parse(storedResult);
                    console.log('Loaded prediction result:', data);
                    displayResults(data);
                } catch (error) {
                    console.error('Error parsing stored results:', error);
                    displayError('Error loading prediction results. Please go back and try again.');
                }
            } else {
                console.warn('No prediction results found in localStorage');
                displayError('No prediction results found. Please complete a risk assessment first.');
            }
        });

        function displayError(message) {
            document.getElementById('mainRiskIndicator').innerHTML = `
                <div class="error-message">
                    <h2><i class="fas fa-exclamation-triangle"></i> Error</h2>
                    <p>${message}</p>
                    <a href="/predict" class="btn btn-action mt-3">
                        <i class="fas fa-arrow-left"></i> Go to Risk Assessment
                    </a>
                </div>
            `;
        }

        function displayResults(data) {
            if (!data || !data.success) {
                displayError('Invalid prediction results. Please try again.');
                return;
            }

            console.log('Displaying results for:', data);

            // Main risk indicator
            const riskLevel = data.predicted_severity || data.risk_level || 'Unknown';
            const riskScore = data.risk_score || 0;
            const confidence = ((data.confidence || 0) * 100).toFixed(1);
            
            let riskClass = 'risk-low';
            let riskIcon = 'fas fa-shield-alt';
            
            // Determine risk class based on severity or score
            if (riskLevel.toLowerCase().includes('high') || riskScore > 60) {
                riskClass = 'risk-high';
                riskIcon = 'fas fa-exclamation-triangle';
            } else if (riskLevel.toLowerCase().includes('medium') || riskScore > 30) {
                riskClass = 'risk-medium';
                riskIcon = 'fas fa-exclamation-circle';
            }

            document.getElementById('mainRiskIndicator').innerHTML = `
                <div class="risk-indicator ${riskClass}">
                    <h2><i class="${riskIcon}"></i> ${riskLevel}</h2>
                    <p class="mb-0">Overall Risk Assessment for Your Journey</p>
                </div>
            `;

            // Update metrics
            document.getElementById('riskScore').textContent = riskScore.toFixed(1) + '%';
            document.getElementById('confidenceScore').textContent = confidence + '%';
            document.getElementById('parametersAnalyzed').textContent = data.debug_info?.features_analyzed || data.model_info?.features_analyzed || '18';

            // Update probability bars
            const probabilities = data.probabilities || {};
            const lowPercent = ((probabilities.slight || probabilities.low || 0) * 100).toFixed(1);
            const mediumPercent = ((probabilities.serious || probabilities.medium || 0) * 100).toFixed(1);
            const highPercent = ((probabilities.fatal || probabilities.high || 0) * 100).toFixed(1);

            // Update progress bars
            updateProgressBar('lowRisk', lowPercent);
            updateProgressBar('mediumRisk', mediumPercent);
            updateProgressBar('highRisk', highPercent);

            // Risk factors
            if (data.risk_factors && data.risk_factors.length > 0) {
                document.getElementById('riskFactors').innerHTML = data.risk_factors
                    .map(factor => `<span class="factor-badge">${factor}</span>`)
                    .join('');
            } else {
                document.getElementById('riskFactors').innerHTML = 
                    '<p class="text-muted">No significant risk factors detected</p>';
            }

            // Location info
            const locationAddress = data.location?.address || data.location || 'Not specified';
            document.getElementById('assessedLocation').textContent = locationAddress;
            document.getElementById('areaType').textContent = data.location?.risk_zone ? 'High-Risk Zone' : 'Standard Zone';
            document.getElementById('historicalRisk').textContent = data.location?.risk_zone ? 'Above Average' : 'Average';

            // Time info
            const assessmentDate = new Date(data.timestamp || Date.now());
            document.getElementById('assessmentTime').textContent = assessmentDate.toLocaleString();
            document.getElementById('timeOfDay').textContent = getTimeOfDay(assessmentDate.getHours());
            document.getElementById('dayType').textContent = isWeekend(assessmentDate) ? 'Weekend' : 'Weekday';

            // Recommendations
            if (data.recommendations && data.recommendations.length > 0) {
                document.getElementById('recommendationsSection').style.display = 'block';
                document.getElementById('recommendationsList').innerHTML = data.recommendations
                    .map(rec => `<div class="recommendation-item">${rec}</div>`)
                    .join('');
            }
        }

        function updateProgressBar(type, percent) {
            const percentElement = document.getElementById(type + 'Percent');
            const barElement = document.getElementById(type + 'Bar');
            
            if (percentElement && barElement) {
                percentElement.textContent = `(${percent}%)`;
                barElement.style.width = percent + '%';
                barElement.textContent = percent + '%';
            }
        }

        function getTimeOfDay(hour) {
            if (hour >= 6 && hour < 12) return 'Morning';
            if (hour >= 12 && hour < 17) return 'Afternoon';
            if (hour >= 17 && hour < 21) return 'Evening';
            return 'Night';
        }

        function isWeekend(date) {
            return date.getDay() === 0 || date.getDay() === 6;
        }

        function shareResults() {
            if (navigator.share) {
                navigator.share({
                    title: 'Road Safety Risk Assessment',
                    text: 'Check out my AI-powered road safety risk assessment results!',
                    url: window.location.href
                });
            } else {
                // Fallback - copy to clipboard
                navigator.clipboard.writeText(window.location.href).then(() => {
                    alert('Results link copied to clipboard!');
                }).catch(() => {
                    alert('Unable to copy link. Please share manually.');
                });
            }
        }
    </script>
</body>
</html>